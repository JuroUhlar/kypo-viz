<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Event log prototype</title>
        <link rel="stylesheet" type="text/css" href="main.css">
        <script type="text/javascript" src="d3/d3.js"></script>
        <style>

          

            svg circle {
                opacity: 0.75;
            }
       

            svg circle.hint {
                fill: grey;
            } 

            svg circle.premature-exit {
                fill: black;
            }

            svg circle.help-level {
                fill: purple;
            }

            h1 {
                font-size: 14px;
                text-align: center;
            }
           
            
        </style>


    </head>
    <body>

        <h1>KYPO game event log prototype</h1>
        <div id="chart" width="100%"></div>
        <div id="text-log"></div>

               <!--  <label class="">
                  <input type="checkbox" onclick="toggleThings(lines)" checked>
                  <div class="slider round"></div>Toggle Lines
                </label>
                  <label><input type="checkbox" /> Label text</label> -->

        <form>
            <div>
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(lines)" checked/>
                    <span style="color: black">&#9644;</span> 
                    Show level lines</label> 
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(hints)" checked/>
                   <span style="color: grey">&#9899;</span> 
                    Show hints</label> 
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(correctFlags)" checked/> 
                    <span style="color: black">&#9898;</span> 
                    Show correct flags</label> 
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(wrongFlags)" checked/>
                    <span style="color: red">&#9899;</span>
                    Show incorrent flags</label> 
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(gameStarts),
                                                                            toggleThings(gameFinishes)" checked/>
                    <span style="color: black">&#9898;</span> 
                    Show game starts and finishes</label> 
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(levelSkips)" checked/>
                    <span style="color: black">&#9899;</span>
                    Show level skips</label> 
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(prematureExits)" checked/>
                    <span style="color: black">&#9899;</span>
                    Show premature exits</label> 
                <label><input type="checkbox" class="event-toggle" onclick="toggleThings(helpLevelEvents)" checked/>
                    <span style="color: purple">&#9899;</span>
                    Show help level events</label> 
            </div>
            <div>
                <button type="button" onclick="showAll()"> Show all </button>
                <button type="button" onclick="hideAll()"> Hide all </button>
            </div>
        <form>
 

        <script type="text/javascript">

        //**************************************************
        // FUNCTIOONs TO HELP WITH TIMES PARSING AND CONVERSIONS, nasty stuff

        function StrDateToTime(snippet){
            var time = snippet.slice(11,19);
            return time;
        }

        function StrTimeToSeconds(snippet) {
            var parsedTime = snippet.match(/[0-9][0-9]/g);
            return (+parsedTime[0] * 3600) + (+parsedTime[1] * 60) + (+parsedTime[2]);
        }

        function GetSeconds(snippet) {
            return StrTimeToSeconds(StrDateToTime(snippet));
        }

        String.prototype.toHHMMSS = function () {
            var sec_num = parseInt(this, 10); // don't forget the second param
            var hours   = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = sec_num - (hours * 3600) - (minutes * 60);

            if (hours   < 10) {hours   = "0"+hours;}
            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            return hours+':'+minutes+':'+seconds;
        }

        // ************************************************************
        // VARIABLES AND A FUNCTIONS FOR TOGGLING/FILTERING VISUAL ELEMENTS

        var lines = document.getElementsByClassName("level-line");
        
        var correctFlags = document.getElementsByClassName("correct-flag");
        var wrongFlags = document.getElementsByClassName("wrong-flag");
        var prematureExits = document.getElementsByClassName("premature-exit");
        var levelSkips = document.getElementsByClassName("level-skip");
        var gameFinishes = document.getElementsByClassName("game-finished");
        var gameStarts = document.getElementsByClassName("game-started");
        var hints = document.getElementsByClassName("hint");
        var helpLevelEvents = document.getElementsByClassName("help-level");
        var allThings = [lines, correctFlags, wrongFlags, prematureExits, levelSkips, gameFinishes, gameStarts, hints, helpLevelEvents];

        var toggles = document.getElementsByClassName("event-toggle");

        function toggleThings(things){ 
             for (var i = 0; i< things.length; i++) {
                    if (things[i].style.display != "none") {
                        things[i].style.display = "none";
                    } else {
                        things[i].style.display = "block";
                    }
                };
        }

        // FUNCTIONS THAT SHOW/HIDE ALL ELEMENTS AND UPDATE CHECKBOXES
        // TO-DO: Refactor into one method
        function hideAll() {
            for(var i = 0; i < allThings.length; i++){
                for(var j = 0; j < allThings[i].length; j++) {
                    allThings[i][j].style.display = "none";
                }
            }
            for (var i = 0; i < toggles.length; i++) {
                toggles[i].checked = false;
            }
            return;
        }

        function showAll() {
            for(var i = 0; i < allThings.length; i++){
                for(var j = 0; j < allThings[i].length; j++) {
                    allThings[i][j].style.display = "block";
                }
            }
            for (var i = 0; i < toggles.length; i++) {
                toggles[i].checked = true;
            }
            return;
        }

        // On page the load, all the event visual elements are drawn, so make all boxes checked to make sure they are in sync with the visuals
        window.onload = function () { 
            for (var i = 0; i < toggles.length; i++) {
                toggles[i].checked = true;
            }
        }

        //*************************************************************
        // VARIABLES FOR WINDOWS SIZES, BORDERS AND SUCH SVG STUFF 

        var width = window.innerWidth - 40;
        var height = window.innerHeight - 100;
        var padding_horizontal = 20;
        var padding_vertical = 20;
        var color = d3.scaleOrdinal(d3.schemeCategory20);

        var legendRectSize = 18;
        var legendSpacing = 4;


        var svg = d3.select('#chart')
                    .append("svg")
                    .attr("height", height)
                    .attr("width", width);


        //******************************************************           
        // CODE DEPENDENT ON THE AVAILABILITY Of DATA   

        d3.csv("all-events.csv", function (error, dataset) {

                    var players = [];
                    var startTimes = [];

                    dataset.forEach(function (d) {
                        if(players.indexOf(d.ID) === -1){
                            players.push(d.ID); 
                        }
                        
                        // d.game_seconds = StrTimeToSeconds(d.logical_time);
                    });

                    dataset.forEach(function (d){
                        if(d.event === "Game started"){
                            startTimes[players.indexOf(d.ID)] = GetSeconds(d.timestamp); 
                        }
                    });

                    dataset.forEach(function (d) {
                        d.game_seconds = GetSeconds(d.timestamp) - startTimes[players.indexOf(d.ID)];
                        // console.log(d.game_seconds);
                    });

                    // console.log(startTimes);

                    var xScale = d3.scaleLinear()
                                             .domain([0, d3.max(dataset, function(d) { return d.game_seconds; })])
                                             .range([padding_horizontal, width - padding_horizontal]);

                    var yScale = d3.scaleLinear() // accept players index in array
                                             .domain([0, players.length])
                                             .range([padding_vertical, height - padding_vertical]);

                    var playerColorScale = d3.scaleOrdinal(d3.schemeCategory20b);

                    
                    //***********************************************
                    // LINES CERRESPONDING TO DURATION OF EACH LEVEL 

                    svg.selectAll("line")
                        .data(dataset.filter(function (d) {
                           return d.event === "Correct flag submited" || d.event === "Game finished" || 
                                  d.event === "Level cowardly skipped" || d.event === "Game exited prematurely"; 
                        }))
                        .enter()
                        .append("line")
                        .attr("y1", function (d) {
                            return yScale(players.indexOf(d.ID));
                        })
                        .attr("y2", function (d) {
                            return yScale(players.indexOf(d.ID));
                        })
                        .attr("x2", function (d) {
                            return xScale(d.game_seconds);
                        })
                        .attr("x1", function (d) {
                            currentLevel = d.level;
                            currentPlayer = d.ID;
                            var levelStart = dataset.filter(function (d) {
                                return (d.ID === currentPlayer) &&
                                       (
                                            (+d.level === +currentLevel - 1 &&
                                                    (d.event === "Correct flag submited" ||
                                                     d.event === "Level cowardly skipped"))
                                            || 
                                            (currentLevel === "1" && d.event === "Game started")
                                        );
                            })[0];
                            return xScale(levelStart.game_seconds);
                        })
                        .attr("stroke-width", "3")
                        .attr("class", "level-line")
                        .attr("stroke", function (d){
                            return color(d.level);
                        });

                    //************************************************    
                    // CIRCLES CORRESPONDING TO ALL GAME EVENTS

                        svg.selectAll("circle")
                        .data(dataset)
                        .enter()
                        .append("circle")
                        .attr("cx", function (d) {
                            return xScale(d.game_seconds);
                        })
                        .attr("cy", function (d) {
                            // return Math.random() * height;
                            return yScale(players.indexOf(d.ID));
                        })
                        .attr("r", function (d) {
                            if (d.event === "Correct flag submited" || 
                                d.event === "Game finished" ||
                                d.event === "Game exited prematurely") {
                                return 7; 
                            } else {
                                return 5;
                            }
                        })
                        .attr("fill", function  (d){
                            if(d.event.indexOf("Wrong flag submited") != -1 ||
                                d.event == "Game exited prematurely") {
                                return "red";
                            } else if (d.event === "Level cowardly skipped") {
                                return "black";
                            } else {
                                return color(d.level);
                            }                           
                            // return (d.event.indexOf("Wrong flag submited") != -1) ? "red" : color(d.level);
                            // return color(d.level);    
                        })
                        .attr("class", function (d){
                            if (d.event === "Game exited prematurely") {
                                return "premature-exit";
                            } else if (d.event === "Level cowardly skipped") {
                                return "level-skip";
                            } else if (d.event === "Correct flag submited") {
                                return "correct-flag";
                            } else if (d.event === "Game finished") {
                                return "game-finished";
                            } else if (d.event === "Game started") {
                                return "game-started";
                            } else if (d.event.indexOf("Hint") != -1 ) {
                                return "hint";
                            } else if (d.event.indexOf("Wrong flag submited") != -1 ) {
                                return "wrong-flag";
                            }  else if (d.event.indexOf("Help level") != -1 || d.event.indexOf("help level") != -1) {
                                return "help-level";
                            }  else return ""; 
                        })
                        .attr("stroke-width", "1")
                        .attr("stroke", "grey")
                        // .attr("opacity", "0.5")
                        .append("title")
                        .text(function (d) {
                            return  "Event: " + d.event + "\n" +
                                    "Player " + players.indexOf(d.ID) + " (" + d.ID + ") \n" + 
                                    "Level: " + d.level + "\n" +
                                    "Level time: " + d.logical_time + "\n" + 
                                    "Game time: " + (d.game_seconds+"").toHHMMSS();  
                        });


                          

                    // console.log(dataset);

                    // var log = d3.select("#text-log")
                    //             .selectAll("p")
                    //             .data(dataset)
                    //             .enter()
                    //             .append("p")
                    //             .text(function (d) {
                    //                 return (d.ID + " | " + d.timestamp + " | " + d.logical_time + " | " + d.level + " | " + d.event);
                    //             });
                });  
        
        </script>
<!--  -->
        

    </body>
</html>